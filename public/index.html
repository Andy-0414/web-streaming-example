<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
		<script src="/socket.io-client/dist/socket.io.js"></script>
		<title>HLS</title>
	</head>
	<body>
		<video playsinline id="local" controls preload="metadata" autoplay width="300"></video>
		<video playsinline id="remote" controls preload="metadata" autoplay width="300"></video>
	</body>
	<script>
		const RTC_CONFIGURATION = {
			iceServers: [
				{ urls: "stun:stun.l.google.com:19302" },
				{
					url: "turn:numb.viagenie.ca",
					credential: "muazkh",
					username: "webrtc@live.com",
				},
			],
		};

		let socket = io.connect("http://localhost:3000/");

		let localVideo = document.getElementById("local");
		let remoteVideo = document.getElementById("remote");
		let media;
		let localStream;
		let pc1 = new RTCPeerConnection(RTC_CONFIGURATION);
		let pc2 = new RTCPeerConnection(RTC_CONFIGURATION);

		function selectDesktop() {
			if (navigator.getDisplayMedia) {
				return navigator.getDisplayMedia({ video: true });
			} else if (navigator.mediaDevices.getDisplayMedia) {
				return navigator.mediaDevices.getDisplayMedia({ video: true });
			} else {
				return navigator.mediaDevices.getUserMedia({ video: { mediaSource: "screen" } });
			}
		}
		async function start() {
			let stream = await selectDesktop();
			localVideo.srcObject = stream;
			localStream = stream;

			pc1.addEventListener("icecandidate", async (e) => {
				console.log(e.candidate);
				if (e.candidate) await pc2.addIceCandidate(e.candidate);
			});
			pc2.addEventListener("icecandidate", async (e) => {
				console.log(e.candidate);
				if (e.candidate) await pc1.addIceCandidate(e.candidate);
			});

			pc2.addEventListener("track", (e) => {
				remoteVideo.srcObject = e.streams[0];
			});

			localStream.getTracks().forEach((track) => pc1.addTrack(track, localStream));

			let offer = await pc1.createOffer({
				offerToReceiveAudio: 1,
				offerToReceiveVideo: 1,
			});
			await pc1.setLocalDescription(offer);
			await pc2.setRemoteDescription(offer);

			let answer = await pc2.createAnswer();
			await pc2.setLocalDescription(answer);
			await pc1.setRemoteDescription(answer);
		}
		start();
	</script>
</html>
